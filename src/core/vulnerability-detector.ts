export interface Vulnerability {
    type: "xss" | "sqli" | "csrf" | "header" | "sensitive_data" | "other";
    severity: "critical" | "high" | "medium" | "low" | "info";
    title: string;
    description: string;
    url: string;
    evidence?: string;
    remediation?: string;
    cwe?: string;
}

export interface ScanResult {
    target: string;
    timestamp: string;
    duration: number;
    vulnerabilities: Vulnerability[];
    summary: {
        total: number;
        critical: number;
        high: number;
        medium: number;
        low: number;
        info: number;
    };
    metadata: {
        crawledUrls: number;
        testedForms: number;
        requestsMade: number;
    };
}

export class VulnerabilityDetector {
    private vulnerabilities: Vulnerability[] = [];

    // XSS Detection
    detectXSS(url: string, param: string, payload: string, response: string): void {
        // Check if payload is reflected in response
        if (response.includes(payload)) {
            this.vulnerabilities.push({
                type: "xss",
                severity: "high",
                title: "Reflected Cross-Site Scripting (XSS)",
                description: `The parameter '${param}' appears to be vulnerable to XSS. The payload was reflected in the response without proper encoding.`,
                url,
                evidence: `Payload: ${payload}`,
                remediation:
                    "Implement proper output encoding/escaping for user-controlled data. Use Content Security Policy (CSP) headers.",
                cwe: "CWE-79",
            });
        }
    }

    // SQL Injection Detection
    detectSQLi(url: string, param: string, errorResponse: string): void {
        const sqlErrors = [
            "SQL syntax",
            "mysql_fetch",
            "ORA-",
            "PostgreSQL",
            "SQLite",
            "ODBC",
            "JET Database",
            "Microsoft Access Driver",
        ];

        for (const error of sqlErrors) {
            if (errorResponse.includes(error)) {
                this.vulnerabilities.push({
                    type: "sqli",
                    severity: "critical",
                    title: "SQL Injection",
                    description: `The parameter '${param}' may be vulnerable to SQL injection. Database error messages were detected in the response.`,
                    url,
                    evidence: `Error pattern: ${error}`,
                    remediation:
                        "Use parameterized queries or prepared statements. Never concatenate user input directly into SQL queries.",
                    cwe: "CWE-89",
                });
                break;
            }
        }
    }

    // CSRF Detection
    detectCSRF(url: string, formHtml: string): void {
        const hasCSRFToken =
            formHtml.includes('name="csrf') ||
            formHtml.includes('name="_token') ||
            formHtml.includes('name="authenticity_token');

        if (!hasCSRFToken) {
            this.vulnerabilities.push({
                type: "csrf",
                severity: "medium",
                title: "Missing CSRF Protection",
                description:
                    "The form does not appear to have CSRF token protection. This could allow attackers to perform unauthorized actions on behalf of authenticated users.",
                url,
                remediation:
                    "Implement CSRF tokens for all state-changing operations. Use SameSite cookie attribute.",
                cwe: "CWE-352",
            });
        }
    }

    // Security Headers Analysis
    analyzeSecurityHeaders(url: string, headers: Record<string, string>): void {
        const requiredHeaders = {
            "content-security-policy": {
                title: "Missing Content-Security-Policy",
                severity: "medium" as const,
                remediation:
                    "Implement a strict Content-Security-Policy to prevent XSS and data injection attacks.",
            },
            "x-frame-options": {
                title: "Missing X-Frame-Options",
                severity: "medium" as const,
                remediation:
                    "Set X-Frame-Options to DENY or SAMEORIGIN to prevent clickjacking attacks.",
            },
            "strict-transport-security": {
                title: "Missing Strict-Transport-Security",
                severity: "medium" as const,
                remediation:
                    "Enable HSTS to force HTTPS connections and prevent protocol downgrade attacks.",
            },
            "x-content-type-options": {
                title: "Missing X-Content-Type-Options",
                severity: "low" as const,
                remediation: "Set X-Content-Type-Options to 'nosniff' to prevent MIME-sniffing attacks.",
            },
        };

        for (const [header, config] of Object.entries(requiredHeaders)) {
            if (!headers[header.toLowerCase()]) {
                this.vulnerabilities.push({
                    type: "header",
                    severity: config.severity,
                    title: config.title,
                    description: `The ${header} security header is not set.`,
                    url,
                    remediation: config.remediation,
                });
            }
        }
    }

    // Sensitive Data Detection
    detectSensitiveData(url: string, response: string): void {
        const patterns = [
            { regex: /api[_-]?key["\s:=]+[\w-]{20,}/gi, name: "API Key" },
            { regex: /sk-[a-zA-Z0-9]{48}/g, name: "OpenAI API Key" },
            { regex: /ghp_[a-zA-Z0-9]{36}/g, name: "GitHub Token" },
            { regex: /AKIA[0-9A-Z]{16}/g, name: "AWS Access Key" },
            { regex: /password["\s:=]+[^\s"]{8,}/gi, name: "Password" },
        ];

        for (const pattern of patterns) {
            const matches = response.match(pattern.regex);
            if (matches && matches.length > 0) {
                this.vulnerabilities.push({
                    type: "sensitive_data",
                    severity: "high",
                    title: `Exposed ${pattern.name}`,
                    description: `Potential ${pattern.name} found in the response. Sensitive data should never be exposed in client-side code.`,
                    url,
                    evidence: `Pattern matched: ${matches[0].substring(0, 20)}...`,
                    remediation:
                        "Remove sensitive data from responses. Use environment variables and secure secret management.",
                    cwe: "CWE-200",
                });
            }
        }
    }

    getVulnerabilities(): Vulnerability[] {
        return this.vulnerabilities;
    }

    getSummary() {
        const summary = {
            total: this.vulnerabilities.length,
            critical: 0,
            high: 0,
            medium: 0,
            low: 0,
            info: 0,
        };

        for (const vuln of this.vulnerabilities) {
            summary[vuln.severity]++;
        }

        return summary;
    }

    clear(): void {
        this.vulnerabilities = [];
    }
}
